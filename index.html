<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <!-- ÊâãÊú∫ÈÄÇÈÖçÔºåÁ¶ÅÊ≠¢Áº©ÊîæÈÅøÂÖçËØØËß¶ -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Êñ∞Êò•ÁîªÂç∑ - ÊâãÊú∫ÂÖºÂÆπÁâà</title>
  <style>
    :root {
      --primary-red: #8B0000;
      --gold: #FFD700;
      --bg-color: #2c2c2c;
      --cols: 7;
      --rows: 5;

      /* TILE_SIZE ‰ºöÊ†πÊçÆÂ±èÂπïÂÆΩÂ∫¶Âú® JS ÈáåÂä®ÊÄÅË∞ÉÊï¥ */
      --tile-size: 80px;
      --board-w: calc(var(--cols) * var(--tile-size));
      --board-h: calc(var(--rows) * var(--tile-size));
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Microsoft YaHei", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--bg-color);
      color: #fff;
      margin: 0;
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
      overflow: hidden;
    }

    #drag-layer {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
    }

    .header {
      width: 100%;
      max-width: 900px;
      background: linear-gradient(to bottom, #4a1212, #2a0a0a);
      border: 2px solid var(--gold);
      border-radius: 10px;
      padding: 8px 12px;
      margin-bottom: 10px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
    }

    .title {
      font-size: 20px;
      color: var(--gold);
      font-weight: bold;
      flex: 1 1 auto;
      min-width: 130px;
    }

    .status-bar {
      display: flex;
      gap: 12px;
      font-size: 16px;
      align-items: center;
      flex-shrink: 0;
    }

    .btn-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-left: auto;
    }

    .btn {
      background: linear-gradient(to bottom, #f3dba9, #dcb365);
      border: 1px solid #5c3c12;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      color: #3e2706;
      font-size: 14px;
    }

    .btn:active {
      transform: translateY(1px);
    }

    #fileInput { display: none; }

    .game-container {
      width: 100%;
      max-width: 900px;
      display: flex;
      gap: 12px;
      align-items: flex-start;
      justify-content: center;
      flex: 1 1 auto;
    }

    .board-wrapper {
      position: relative;
      flex-shrink: 0;
    }

    #board {
      display: grid;
      grid-template-columns: repeat(var(--cols), var(--tile-size));
      grid-template-rows: repeat(var(--rows), var(--tile-size));
      width: var(--board-w);
      height: var(--board-h);
      background: rgba(0, 0, 0, 0.5);
      border: 4px solid var(--gold);
      position: relative;
      overflow: hidden;
    }

    .grid-slot {
      border: 1px dashed rgba(255, 255, 255, 0.08);
      width: var(--tile-size);
      height: var(--tile-size);
    }

    #previewOverlay {
      position: absolute;
      inset: 0;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      z-index: 2;
    }

    #previewOverlay.show {
      opacity: 0.7;
    }

    #dock {
      flex: 0 0 170px;
      max-height: var(--board-h);
      background: rgba(0, 0, 0, 0.35);
      border: 2px solid #555;
      padding: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      overflow-y: auto;
    }

    .piece {
      width: var(--tile-size);
      height: var(--tile-size);
      background-repeat: no-repeat;
      background-size: var(--board-w) var(--board-h);
      cursor: grab;
      box-shadow: 0 0 4px rgba(0,0,0,0.5);
      position: relative;
      touch-action: none;
      -webkit-user-drag: none;
      -webkit-user-select: none;
    }

    .piece.dragging {
      box-shadow: 0 0 10px rgba(255,255,255,0.8);
      transform: scale(1.05);
      z-index: 9999;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .modal-content {
      background: #fff;
      color: #333;
      padding: 20px;
      border-radius: 10px;
      border: 4px solid var(--primary-red);
      width: 80%;
      max-width: 360px;
      text-align: center;
    }

    .modal-content h2 {
      margin-top: 0;
    }

    .star-result {
      font-size: 26px;
      color: #e3b028;
      margin: 6px 0;
    }

    /* ÊâãÊú∫Á´ØÔºö‰∏ä‰∏ãÂ∏ÉÂ±Ä */
    @media (max-width: 768px) {
      body {
        padding: 8px;
        overflow: hidden;
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
      }

      .game-container {
        flex-direction: column;
        align-items: center;
        height: calc(100vh - 140px);
      }

      #board {
        margin-bottom: 6px;
      }

      #dock {
        width: 100%;
        max-height: 40vh;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
      }

      .piece {
        margin: 2px;
      }
    }
  </style>
</head>
<body>
  <div id="drag-layer"></div>

  <div class="header">
    <div class="title">Êñ∞Êò•ÁîªÂç∑ - ÊâãÊú∫ÂÖºÂÆπÁâà</div>
    <div class="status-bar">
      <span id="timerDisplay">‚è± 0:00</span>
      <span id="starDisplay">‚≠ê‚≠ê‚≠ê</span>
    </div>
    <div class="btn-group">
      <input type="file" id="fileInput" accept="image/*">
      <button class="btn" id="chooseImgBtn">üìÇ ÈÄâÊã©ÂõæÁâá</button>
      <button class="btn" id="viewOriginalBtn">üëÄ Êåâ‰ΩèÁúãÂéüÂõæ</button>
      <button class="btn" id="resetBtn">üîÑ ÈáçÁΩÆ</button>
    </div>
  </div>

  <div class="game-container">
    <div class="board-wrapper">
      <div id="board">
        <div id="previewOverlay"></div>
      </div>
    </div>
    <div id="dock"></div>
  </div>

  <div class="modal" id="resultModal">
    <div class="modal-content">
      <h2 id="resultTitle">ÊåëÊàòÊàêÂäüÔºÅ</h2>
      <div class="star-result" id="resultStars">‚≠ê‚≠ê‚≠ê</div>
      <p id="resultTime">Áî®Êó∂Ôºö0:00</p>
      <p id="resultDesc">Êñ∞Á∫™ÂΩïÔºÅ</p>
      <button class="btn" id="closeModalBtn">Á°ÆÂÆö</button>
    </div>
  </div>

  <script>
    const COLS = 7;
    const ROWS = 5;

    let TILE_SIZE = 80;
    let BOARD_W = COLS * TILE_SIZE;
    let BOARD_H = ROWS * TILE_SIZE;

    let currentImgUrl = './image.jpg';
    const FALLBACK_IMG = 'https://picsum.photos/560/400';

    const boardEl = document.getElementById('board');
    const dockEl = document.getElementById('dock');
    const overlayEl = document.getElementById('previewOverlay');
    const dragLayer = document.getElementById('drag-layer');

    const timerEl = document.getElementById('timerDisplay');
    const starEl = document.getElementById('starDisplay');
    const modalEl = document.getElementById('resultModal');
    const resultTitleEl = document.getElementById('resultTitle');
    const resultStarsEl = document.getElementById('resultStars');
    const resultTimeEl = document.getElementById('resultTime');
    const resultDescEl = document.getElementById('resultDesc');

    const fileInput = document.getElementById('fileInput');
    const chooseImgBtn = document.getElementById('chooseImgBtn');
    const viewOriginalBtn = document.getElementById('viewOriginalBtn');
    const resetBtn = document.getElementById('resetBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');

    let pieces = [];            // {id, targetX, targetY, placedX, placedY, el}
    let occupied = [];          // occupied[x][y] = piece or null

    let isGaming = false;
    let secondsElapsed = 0;
    let timerInterval = null;

    let draggingPiece = null;
    let draggingEl = null;
    let dragOffsetX = 0;
    let dragOffsetY = 0;

    function setupResponsive() {
      const w = window.innerWidth;
      let size;
      if (w <= 768) {
        size = Math.floor((w - 40) / COLS);
        if (size < 40) size = 40;
        if (size > 80) size = 80;
      } else {
        size = 80;
      }
      TILE_SIZE = size;
      BOARD_W = COLS * TILE_SIZE;
      BOARD_H = ROWS * TILE_SIZE;

      document.documentElement.style.setProperty('--tile-size', TILE_SIZE + 'px');
      document.documentElement.style.setProperty('--board-w', BOARD_W + 'px');
      document.documentElement.style.setProperty('--board-h', BOARD_H + 'px');

      boardEl.style.width = BOARD_W + 'px';
      boardEl.style.height = BOARD_H + 'px';
    }

    function buildGrid() {
      boardEl.innerHTML = '';
      boardEl.appendChild(overlayEl);
      boardEl.style.position = 'relative';

      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          const slot = document.createElement('div');
          slot.className = 'grid-slot';
          boardEl.appendChild(slot);
        }
      }
    }

    function initGame() {
      isGaming = true;
      secondsElapsed = 0;
      updateTimerView();
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(tickTimer, 1000);

      overlayEl.style.backgroundImage = 'url("' + currentImgUrl + '")';

      pieces = [];
      occupied = [];
      for (let x = 0; x < COLS; x++) {
        occupied[x] = [];
        for (let y = 0; y < ROWS; y++) {
          occupied[x][y] = null;
        }
      }

      dockEl.innerHTML = '';

      const tmp = [];
      for (let y = 0; y < ROWS; y++) {
        for (let x = 0; x < COLS; x++) {
          tmp.push({ targetX: x, targetY: y });
        }
      }
      shuffle(tmp);

      tmp.forEach((info, idx) => {
        const piece = {
          id: idx,
          targetX: info.targetX,
          targetY: info.targetY,
          placedX: -1,
          placedY: -1,
          el: null
        };
        createPieceElement(piece);
        pieces.push(piece);
      });
    }

    function createPieceElement(piece) {
      const el = document.createElement('div');
      el.className = 'piece';
      el.style.backgroundImage = 'url("' + currentImgUrl + '")';
      el.style.backgroundSize = BOARD_W + 'px ' + BOARD_H + 'px';
      el.style.backgroundPosition =
        '-' + (piece.targetX * TILE_SIZE) + 'px -' + (piece.targetY * TILE_SIZE) + 'px';

      piece.el = el;

      // Èº†Ê†á‰∫ã‰ª∂
      el.addEventListener('mousedown', (e) => {
        startDrag(e, piece);
      });

      // Ëß¶Êë∏‰∫ã‰ª∂
      el.addEventListener('touchstart', (e) => {
        startDrag(e, piece);
      }, { passive: false });

      dockEl.appendChild(el);
    }

    function startDrag(e, piece) {
      if (!isGaming) return;
      e.preventDefault();

      const point = getPoint(e);

      draggingPiece = piece;
      draggingEl = piece.el;

      draggingEl.classList.add('dragging');

      const rect = draggingEl.getBoundingClientRect();
      dragOffsetX = point.clientX - rect.left;
      dragOffsetY = point.clientY - rect.top;

      // ‰ªéÂéüÂÆπÂô®ÁßªÂà∞ drag-layer
      dragLayer.appendChild(draggingEl);
      draggingEl.style.position = 'absolute';
      draggingEl.style.left = rect.left + 'px';
      draggingEl.style.top = rect.top + 'px';

      // Â¶ÇÊûúÂéüÊù•ÊîæÂú®Ê£ãÁõò‰∏äÔºåÂÖàËÖæ‰ΩçÁΩÆ
      if (piece.placedX !== -1) {
        occupied[piece.placedX][piece.placedY] = null;
        piece.placedX = -1;
        piece.placedY = -1;
      }

      document.addEventListener('mousemove', onDragMove);
      document.addEventListener('mouseup', onDragEnd);
      document.addEventListener('touchmove', onDragMove, { passive: false });
      document.addEventListener('touchend', onDragEnd);
      document.addEventListener('touchcancel', onDragEnd);
    }

    function onDragMove(e) {
      if (!draggingEl) return;
      const point = getPoint(e);
      if (!point) return;
      e.preventDefault();

      draggingEl.style.left = (point.clientX - dragOffsetX) + 'px';
      draggingEl.style.top = (point.clientY - dragOffsetY) + 'px';
    }

    function onDragEnd(e) {
      document.removeEventListener('mousemove', onDragMove);
      document.removeEventListener('mouseup', onDragEnd);
      document.removeEventListener('touchmove', onDragMove);
      document.removeEventListener('touchend', onDragEnd);
      document.removeEventListener('touchcancel', onDragEnd);

      if (!draggingEl || !draggingPiece) return;

      const point = getPoint(e) || { clientX: 0, clientY: 0 };

      const boardRect = boardEl.getBoundingClientRect();
      const centerX = point.clientX;
      const centerY = point.clientY;

      const relX = centerX - boardRect.left;
      const relY = centerY - boardRect.top;

      let snapped = false;

      if (relX >= 0 && relX <= BOARD_W && relY >= 0 && relY <= BOARD_H) {
        const gridX = Math.floor(relX / TILE_SIZE);
        const gridY = Math.floor(relY / TILE_SIZE);

        if (gridX >= 0 && gridX < COLS && gridY >= 0 && gridY < ROWS) {
          if (!occupied[gridX][gridY]) {
            // Ê≠£ÂºèÊîæÂú®Ê£ãÁõò‰∏ä
            occupied[gridX][gridY] = draggingPiece;
            draggingPiece.placedX = gridX;
            draggingPiece.placedY = gridY;

            boardEl.appendChild(draggingEl);
            draggingEl.style.position = 'absolute';
            draggingEl.style.left = (gridX * TILE_SIZE) + 'px';
            draggingEl.style.top = (gridY * TILE_SIZE) + 'px';

            snapped = true;
          }
        }
      }

      if (!snapped) {
        // ÂõûÂà∞ dock
        draggingEl.style.position = 'relative';
        draggingEl.style.left = '0px';
        draggingEl.style.top = '0px';
        dockEl.appendChild(draggingEl);
      }

      draggingEl.classList.remove('dragging');
      draggingEl = null;
      draggingPiece = null;

      checkWin();
    }

    function getPoint(e) {
      if (e.touches && e.touches[0]) return e.touches[0];
      if (e.changedTouches && e.changedTouches[0]) return e.changedTouches[0];
      return e;
    }

    function tickTimer() {
      if (!isGaming) return;
      secondsElapsed++;
      updateTimerView();
      if (secondsElapsed > 180) {
        // Ë∂ÖÊó∂Â§±Ë¥•
        endGame(false);
      }
    }

    function updateTimerView() {
      const min = Math.floor(secondsElapsed / 60);
      const sec = secondsElapsed % 60;
      timerEl.textContent = '‚è± ' + min + ':' + (sec < 10 ? '0' + sec : sec);

      let starText = '‚≠ê‚≠ê‚≠ê';
      if (secondsElapsed > 120 && secondsElapsed <= 150) starText = '‚≠ê‚≠ê';
      else if (secondsElapsed > 150 && secondsElapsed <= 180) starText = '‚≠ê';
      else if (secondsElapsed > 180) starText = 'üíî';

      starEl.textContent = starText;
    }

    function checkWin() {
      // ÊâÄÊúâÁ¢éÁâáÈÉΩÊîæÂú®Ê£ãÁõò‰∏ä
      const allPlaced = pieces.every(p => p.placedX !== -1);
      if (!allPlaced) return;

      // ÂùêÊ†áÂÆåÂÖ®Ê≠£Á°Æ
      const allCorrect = pieces.every(p =>
        p.placedX === p.targetX && p.placedY === p.targetY
      );

      if (allCorrect) {
        endGame(true);
      }
    }

    function endGame(success) {
      if (!isGaming) return;
      isGaming = false;
      clearInterval(timerInterval);

      if (success) {
        resultTitleEl.textContent = 'ÊÅ≠ÂñúÔºÅÁîªÂç∑‰øÆÂ§çÂÆåÊàê';
        resultTitleEl.style.color = '#d39a1a';
        resultStarsEl.textContent = starEl.textContent;
        resultTimeEl.textContent = 'Áî®Êó∂Ôºö' + timerEl.textContent.replace('‚è± ', '');
        resultDescEl.textContent = 'ÂèØ‰ª•ÊääÈìæÊé•ÂèëÁªôÊúãÂèã‰∏ÄËµ∑ÊåëÊàòÔΩû';
      } else {
        resultTitleEl.textContent = 'ÊåëÊàòÂ§±Ë¥•';
        resultTitleEl.style.color = '#666';
        resultStarsEl.textContent = '';
        resultTimeEl.textContent = 'Ë∂ÖÊó∂Êú™ÂÆåÊàê';
        resultDescEl.textContent = 'ÂÜçËØï‰∏ÄÊ¨°ÂêßÔºÅ';
      }

      modalEl.style.display = 'flex';
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        const tmp = arr[i];
        arr[i] = arr[j];
        arr[j] = tmp;
      }
    }

    function handleImageUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        currentImgUrl = ev.target.result;
        initGame();
      };
      reader.readAsDataURL(file);
    }

    function showOriginal() {
      overlayEl.classList.add('show');
    }

    function hideOriginal() {
      overlayEl.classList.remove('show');
    }

    // ‰∫ã‰ª∂ÁªëÂÆö
    chooseImgBtn.addEventListener('click', () => {
      fileInput.click();
    });

    fileInput.addEventListener('change', handleImageUpload);

    viewOriginalBtn.addEventListener('mousedown', (e) => {
      e.preventDefault();
      showOriginal();
    });
    viewOriginalBtn.addEventListener('mouseup', hideOriginal);
    viewOriginalBtn.addEventListener('mouseleave', hideOriginal);

    // Ëß¶Êë∏Êåâ‰ΩèÈ¢ÑËßà
    viewOriginalBtn.addEventListener('touchstart', (e) => {
      e.preventDefault();
      showOriginal();
    }, { passive: false });
    viewOriginalBtn.addEventListener('touchend', (e) => {
      e.preventDefault();
      hideOriginal();
    });
    viewOriginalBtn.addEventListener('touchcancel', (e) => {
      e.preventDefault();
      hideOriginal();
    });

    resetBtn.addEventListener('click', () => {
      initGame();
    });

    closeModalBtn.addEventListener('click', () => {
      modalEl.style.display = 'none';
    });

    window.addEventListener('resize', () => {
      setupResponsive();
      // ÊèêÁ§∫ÔºöËøôÈáåÊ≤°ÂÆûÊó∂ÈáçÊéíÂ∑≤ÊîæÂ•ΩÁöÑÁ¢éÁâáÔºåÂ¶ÇÊûú‰Ω†Âú® Safari ÈáåÊÉ≥Ë¶Å‰∏•Ë∞®ÁÇπÔºåÁº©ÊîæÂêéÂèØ‰ª•Êåâ‚ÄúÈáçÁΩÆ‚Äù
    });

    function checkDefaultImage() {
      const img = new Image();
      img.onload = function() {
        initGame();
      };
      img.onerror = function() {
        currentImgUrl = FALLBACK_IMG;
        initGame();
      };
      img.src = currentImgUrl;
    }

    // ÂàùÂßãÂåñ
    window.addEventListener('load', () => {
      setupResponsive();
      buildGrid();
      checkDefaultImage();
    });
  </script>
</body>
</html>
